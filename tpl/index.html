<include target="_header.html" />

<form action="./" method="post" ruleset="insertModuleConfig" class="x_form-horizontal"
    onsubmit="return syncJsonBeforeSubmit()">
    <input type="hidden" name="module" value="roulette" />
    <input type="hidden" name="act" value="procRouletteAdminInsertConfig" />
    <input type="hidden" name="success_return_url" value="{getUrl('act', 'dispRouletteAdminIndex')}" />

    <section class="section">
        <h1>룰렛 모듈 설정</h1>

        <div class="x_control-group">
            <label class="x_control-label" for="ticket_point_price">1회당 소모 티켓</label>
            <div class="x_controls">
                <input type="number" id="ticket_point_price" name="ticket_point_price"
                    value="{$config->ticket_point_price}" class="lang_code" />
                <p class="x_help-block">룰렛을 1회 돌릴 때 차감할 티켓 수를 입력하세요. (기본: 1)</p>
            </div>
        </div>

        <div class="x_control-group">
            <label class="x_control-label" for="spin_duration">회전 속도 (초)</label>
            <div class="x_controls">
                <input type="number" id="spin_duration" name="spin_duration" value="{$config->spin_duration}"
                    class="lang_code" step="0.1" />
                <p class="x_help-block">룰렛이 멈출 때까지 걸리는 시간입니다. (기본 3초)</p>
            </div>
        </div>

        <div class="x_control-group">
            <label class="x_control-label">아이템 설정</label>
            <div class="x_controls" style="margin-left: 0; width: 100%;">

                <!-- Hidden JSON Storage -->
                <textarea id="items_json" name="items_json" style="display:none;">{$config->items_json}</textarea>

                <!-- GUI Editor -->
                <table class="x_table x_table-striped x_table-hover" id="items-table"
                    style="width: 100%; border: 1px solid #ddd;">
                    <thead>
                        <tr>
                            <th>메인 텍스트</th>
                            <th>보조 텍스트 (줄바꿈)</th>
                            <th>배경색 (Hex)</th>
                            <th>글자색 (Hex)</th>
                            <th>가중치 (확률)</th>
                            <th>보상 타입</th>
                            <th>수량 (Value)</th>
                            <th>관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be injected by JS -->
                    </tbody>
                </table>

                <div style="margin-top: 10px; text-align: right;">
                    <button type="button" class="x_btn" onclick="addItemRow()">+ 아이템 추가</button>
                    <button type="button" class="x_btn x_btn-danger" onclick="resetToDefaults()">기본값으로 초기화</button>
                </div>

                <p class="x_help-block">
                    * <b>가중치 (Weight)</b>: 숫자가 클수록 당첨 확률이 높아집니다.<br>
                    * <b>보상 타입</b>: Point(포인트 지급) 또는 Ticket(티켓 지급)을 선택하세요.
                </p>
            </div>
        </div>
    </section>

    <div class="x_clearfix btnArea">
        <button type="submit" class="x_btn x_btn-primary">저장</button>
    </div>
</form>

<script>
    // Default Items Data
    const defaultItems = [
        { text: "1천", subText: "캡슐", color: "#FFFFFF", textColor: "#6A4DFF", weight: 0.5, type: "point", value: 1000 },
        { text: "15", subText: "캡슐", color: "#F0F4FF", textColor: "#333", weight: 20, type: "point", value: 15 },
        { text: "25", subText: "캡슐", color: "#FFFFFF", textColor: "#333", weight: 20, type: "point", value: 25 },
        { text: "50", subText: "캡슐", color: "#F0F4FF", textColor: "#333", weight: 15, type: "point", value: 50 },
        { text: "100", subText: "캡슐", color: "#FFFFFF", textColor: "#333", weight: 15, type: "point", value: 100 },
        { text: "150", subText: "캡슐", color: "#F0F4FF", textColor: "#333", weight: 10, type: "point", value: 150 },
        { text: "200", subText: "캡슐", color: "#FFFFFF", textColor: "#333", weight: 10, type: "point", value: 200 },
        { text: "500", subText: "캡슐", color: "#F0F4FF", textColor: "#333", weight: 4.5, type: "point", value: 500 },
        { text: "한번 더!", subText: "티켓 1장", color: "#dbeafe", textColor: "#2563eb", weight: 5, type: "ticket", value: 1 }
    ];

    document.addEventListener("DOMContentLoaded", function () {
        loadFromJSON();
    });

    function loadFromJSON() {
        const raw = document.getElementById('items_json').value;
        let data = [];
        try {
            data = JSON.parse(raw);
        } catch (e) {
            console.error("JSON Parse Error", e);
        }

        if (!Array.isArray(data) || data.length === 0) {
            data = defaultItems; // Use Default if empty
        }

        renderTable(data);
        updateJSON(); // Sync back immediately
    }

    function renderTable(data) {
        const tbody = document.querySelector("#items-table tbody");
        tbody.innerHTML = "";

        data.forEach(item => {
            addItemRow(item);
        });
    }

    function addItemRow(item = null) {
        const tbody = document.querySelector("#items-table tbody");
        const tr = document.createElement("tr");

        // Defaults for new row
        if (!item) {
            item = { text: "새 항목", subText: "설명", color: "#FFFFFF", textColor: "#333333", weight: 10, type: "point", value: 0 };
        }
        // Migration for old data
        if (!item.type) {
            item.type = (item.is_point && item.point_reward > 0) ? 'point' : 'point';
            item.value = item.point_reward || 0;
        }

        tr.innerHTML = `
            <td><input type="text" class="item-text" value="${escapeHtml(item.text)}" style="width: 100px;"></td>
            <td><input type="text" class="item-subText" value="${escapeHtml(item.subText)}" style="width: 100px;"></td>
            <td><input type="color" class="item-color" value="${item.color}"> <small>${item.color}</small></td>
            <td><input type="color" class="item-textColor" value="${item.textColor}"> <small>${item.textColor}</small></td>
            <td><input type="number" class="item-weight" value="${item.weight}" step="0.1" style="width: 60px;"></td>
            <td>
                <select class="item-type" style="width: 80px;">
                    <option value="point" ${item.type === 'point' ? 'selected' : ''}>Point</option>
                    <option value="ticket" ${item.type === 'ticket' ? 'selected' : ''}>Ticket</option>
                </select>
            </td>
            <td><input type="number" class="item-value" value="${item.value || 0}" style="width: 80px;"></td>
            <td><button type="button" class="x_btn x_btn-mini" onclick="removeRow(this)">삭제</button></td>
        `;

        tbody.appendChild(tr);

        // Add Listeners for live sync
        tr.querySelectorAll("input, select").forEach(input => {
            input.addEventListener("input", updateJSON);
            input.addEventListener("change", updateJSON);
        });
    }

    function removeRow(btn) {
        btn.closest("tr").remove();
        updateJSON();
    }

    function resetToDefaults() {
        if (confirm("정말로 모든 설정을 초기화하고 기본값으로 되돌리시겠습니까?")) {
            renderTable(defaultItems);
            updateJSON();
        }
    }

    function updateJSON() {
        const rows = document.querySelectorAll("#items-table tbody tr");
        const data = [];

        rows.forEach(tr => {
            const type = tr.querySelector(".item-type").value;
            const val = parseInt(tr.querySelector(".item-value").value) || 0;

            data.push({
                text: tr.querySelector(".item-text").value,
                subText: tr.querySelector(".item-subText").value,
                color: tr.querySelector(".item-color").value,
                textColor: tr.querySelector(".item-textColor").value,
                weight: parseFloat(tr.querySelector(".item-weight").value) || 0,
                type: type,
                value: val,
                // Legacy compatibility (optional, but good for safety)
                is_point: (type === 'point' && val > 0),
                point_reward: (type === 'point') ? val : 0
            });
        });

        document.getElementById('items_json').value = JSON.stringify(data);
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function syncJsonBeforeSubmit() {
        updateJSON();
        return true;
    }
</script>

<include target="_footer.html" />